import './snowflakes.css'
// todo: figure out how to import svgs
const flake1 = '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="36.283px" height="36.283px" viewBox="0 0 36.283 36.283" style="enable-background:new 0 0 36.283 36.283;" xml:space="preserve"><g><path d="M35.531,17.391h-3.09l0.845-1.464c0.207-0.359,0.083-0.817-0.274-1.024c-0.357-0.207-0.816-0.085-1.023,0.274l-1.276,2.214 h-2.103l2.515-4.354c0.207-0.358,0.084-0.817-0.272-1.024c-0.357-0.207-0.818-0.084-1.024,0.274l-2.948,5.104h-2.023 c-0.213-1.918-1.233-3.591-2.713-4.684l1.019-1.76l5.896-0.002c0.414,0,0.75-0.336,0.75-0.75c0-0.414-0.336-0.75-0.75-0.75 l-5.029,0.002l1.051-1.82l2.557,0.002l0,0c0.413,0,0.75-0.336,0.75-0.75c0-0.414-0.334-0.75-0.75-0.75l-1.689-0.002l1.545-2.676 c0.207-0.358,0.084-0.817-0.273-1.024S26.4,2.343,26.193,2.701l-1.547,2.676l-0.844-1.463c-0.207-0.358-0.668-0.482-1.023-0.274 c-0.358,0.207-0.481,0.666-0.274,1.024l1.278,2.213l-1.051,1.818l-2.514-4.354c-0.207-0.358-0.666-0.481-1.024-0.274 c-0.358,0.207-0.481,0.666-0.274,1.024l2.946,5.104l-1.016,1.758c-0.828-0.365-1.743-0.57-2.706-0.57 c-0.962,0-1.877,0.205-2.707,0.568l-1.013-1.754l2.946-5.105c0.207-0.358,0.084-0.817-0.274-1.024 c-0.358-0.208-0.818-0.084-1.024,0.274L13.56,8.697l-1.05-1.818l1.278-2.217c0.207-0.358,0.084-0.816-0.274-1.023 c-0.36-0.208-0.818-0.085-1.024,0.273l-0.845,1.465l-1.551-2.678C9.887,2.342,9.427,2.219,9.07,2.426 C8.711,2.633,8.589,3.092,8.796,3.449l1.545,2.678H8.652c-0.414,0-0.75,0.336-0.75,0.75c0,0.414,0.336,0.75,0.75,0.75h2.556 l1.05,1.818H7.231c-0.414,0-0.75,0.336-0.75,0.75c0,0.414,0.336,0.75,0.75,0.75h5.894l1.017,1.762 c-1.478,1.092-2.499,2.766-2.712,4.684H9.406l-2.95-5.104c-0.208-0.36-0.667-0.481-1.025-0.274s-0.481,0.666-0.274,1.024 l2.516,4.354H5.569l-1.277-2.213c-0.207-0.359-0.667-0.48-1.024-0.273c-0.359,0.206-0.481,0.666-0.274,1.023l0.845,1.463H0.75 c-0.414,0-0.75,0.336-0.75,0.75s0.336,0.75,0.75,0.75h3.09l-0.845,1.465c-0.207,0.359-0.083,0.817,0.275,1.022 c0.118,0.068,0.247,0.103,0.374,0.103c0.259,0,0.511-0.135,0.65-0.375l1.277-2.215h2.103l-2.516,4.354 c-0.207,0.357-0.084,0.816,0.274,1.023c0.118,0.068,0.247,0.102,0.375,0.102c0.259,0,0.511-0.136,0.65-0.375l2.949-5.104h2.024 c0.213,1.918,1.234,3.591,2.712,4.685l-1.017,1.762H7.232c-0.414,0-0.75,0.336-0.75,0.75s0.336,0.75,0.75,0.75h5.026l-1.05,1.818 H8.651c-0.414,0-0.75,0.336-0.75,0.75c0,0.413,0.336,0.75,0.75,0.75h1.69l-1.545,2.676c-0.207,0.357-0.084,0.816,0.274,1.023 c0.118,0.068,0.247,0.102,0.375,0.102c0.259,0,0.511-0.135,0.65-0.375l1.546-2.676l0.846,1.465c0.139,0.238,0.391,0.375,0.65,0.375 c0.127,0,0.256-0.033,0.375-0.103c0.359-0.207,0.481-0.666,0.274-1.022l-1.279-2.215l1.05-1.82l2.515,4.354 c0.139,0.24,0.391,0.375,0.65,0.375c0.127,0,0.256-0.03,0.375-0.102c0.359-0.206,0.481-0.665,0.274-1.023l-2.947-5.104l1.013-1.756 c0.83,0.364,1.744,0.569,2.707,0.569s1.877-0.205,2.708-0.569l1.014,1.756l-2.947,5.104c-0.207,0.358-0.084,0.817,0.273,1.023 c0.118,0.067,0.247,0.102,0.375,0.102c0.26,0,0.512-0.135,0.65-0.375l2.515-4.354l1.053,1.82l-1.277,2.213 c-0.207,0.358-0.084,0.816,0.273,1.023c0.117,0.066,0.246,0.102,0.375,0.102c0.26,0,0.512-0.136,0.65-0.375l0.844-1.463 l1.545,2.678c0.141,0.24,0.393,0.375,0.65,0.375c0.127,0,0.256-0.032,0.375-0.103c0.358-0.207,0.48-0.666,0.274-1.022l-1.548-2.678 h1.689c0.414,0,0.75-0.338,0.75-0.75c0-0.414-0.336-0.75-0.75-0.75h-2.557l-1.051-1.82l5.029,0.002c0.414,0,0.75-0.336,0.75-0.75 s-0.336-0.75-0.75-0.75l-5.896-0.002l-1.019-1.76c1.479-1.094,2.5-2.767,2.711-4.685h2.023l2.947,5.104 c0.139,0.239,0.391,0.375,0.65,0.375c0.127,0,0.256-0.032,0.375-0.102c0.358-0.207,0.479-0.666,0.272-1.023l-2.515-4.354h2.104 l1.279,2.215c0.139,0.24,0.391,0.375,0.649,0.375c0.127,0,0.256-0.03,0.375-0.103c0.357-0.205,0.48-0.665,0.273-1.022l-0.848-1.465 h3.092c0.414,0,0.75-0.335,0.75-0.75S35.945,17.391,35.531,17.391z M23.395,18.141c0,0.257-0.041,0.502-0.076,0.75 c-0.197,1.36-0.911,2.544-1.943,3.358c-0.393,0.312-0.818,0.574-1.291,0.766c-0.604,0.242-1.259,0.384-1.949,0.384 c-0.69,0-1.344-0.142-1.948-0.384c-0.471-0.188-0.898-0.454-1.291-0.766c-1.032-0.813-1.746-1.998-1.943-3.358 c-0.036-0.247-0.076-0.493-0.076-0.75s0.04-0.503,0.076-0.75c0.197-1.361,0.911-2.545,1.944-3.359 c0.393-0.312,0.82-0.576,1.291-0.765c0.604-0.242,1.258-0.384,1.948-0.384c0.69,0,1.344,0.142,1.948,0.384 c0.471,0.188,0.898,0.454,1.291,0.765c1.032,0.814,1.746,1.998,1.943,3.359C23.354,17.638,23.395,17.884,23.395,18.141z"/></g></svg>'
const flake2 = '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 219.781 219.781" style="enable-background:new 0 0 219.781 219.781;" xml:space="preserve"><path d="M202.314,154.591l-22.323-12.888l19.345-11.407c3.568-2.104,4.755-6.702,2.651-10.27c-2.104-3.567-6.701-4.754-10.27-2.651 l-26.648,15.713l-40.179-23.198l40.172-23.194l26.656,15.711c1.195,0.705,2.507,1.039,3.801,1.039c2.568,0,5.069-1.32,6.468-3.693 c2.103-3.568,0.915-8.166-2.653-10.27L179.986,78.08l22.328-12.891c3.587-2.071,4.816-6.658,2.745-10.245 c-2.071-3.588-6.658-4.817-10.245-2.745l-22.323,12.889l-0.203-22.461c-0.037-4.142-3.435-7.489-7.567-7.432 c-4.142,0.037-7.47,3.425-7.432,7.567l0.279,30.941L117.391,96.9V50.51l26.937-15.224c3.606-2.038,4.877-6.613,2.839-10.22 c-2.038-3.606-6.614-4.878-10.22-2.839L117.391,33.28V7.5c0-4.142-3.358-7.5-7.5-7.5c-4.142,0-7.5,3.358-7.5,7.5v25.78 L82.835,22.228c-3.608-2.039-8.181-0.768-10.22,2.839c-2.038,3.606-0.767,8.182,2.839,10.22l26.936,15.224V96.9L62.213,73.703 l0.279-30.941c0.038-4.142-3.29-7.53-7.432-7.567c-0.023,0-0.045,0-0.069,0c-4.11,0-7.461,3.313-7.498,7.433L47.29,65.088 L24.967,52.199c-3.587-2.072-8.174-0.842-10.245,2.745c-2.071,3.587-0.842,8.174,2.745,10.245L39.794,78.08L20.443,89.485 c-3.568,2.103-4.756,6.701-2.653,10.27c1.399,2.373,3.9,3.693,6.469,3.693c1.294,0,2.605-0.335,3.801-1.039l26.659-15.711 l40.173,23.194l-40.18,23.198L28.06,117.374c-3.566-2.103-8.166-0.917-10.27,2.651c-2.104,3.568-0.917,8.166,2.651,10.269 l19.348,11.408l-22.323,12.888c-3.587,2.071-4.816,6.658-2.745,10.245c1.389,2.406,3.91,3.751,6.502,3.751 c1.272,0,2.562-0.324,3.743-1.006l22.323-12.889l0.203,22.462c0.037,4.119,3.388,7.433,7.498,7.433c0.023,0,0.046,0,0.069-0.001 c4.142-0.037,7.47-3.425,7.432-7.567l-0.279-30.942l40.178-23.197v46.391l-26.936,15.224c-3.606,2.038-4.877,6.613-2.839,10.22 c1.379,2.44,3.92,3.811,6.536,3.811c1.25,0,2.518-0.313,3.684-0.972l19.556-11.052v25.78c0,4.142,3.358,7.5,7.5,7.5 c4.142,0,7.5-3.358,7.5-7.5v-25.78l19.556,11.052c1.166,0.659,2.433,0.972,3.684,0.972c2.616,0,5.157-1.371,6.536-3.811 c2.038-3.606,0.767-8.182-2.839-10.22l-26.937-15.224V122.88l40.177,23.196l-0.286,30.941c-0.039,4.142,3.288,7.531,7.43,7.569 c0.024,0.001,0.047,0.001,0.071,0.001c4.109,0,7.46-3.313,7.498-7.431l0.208-22.465l22.326,12.89 c1.181,0.682,2.471,1.006,3.743,1.006c2.592,0,5.113-1.346,6.502-3.751C207.131,161.249,205.902,156.662,202.314,154.591z"/></svg>'

const snowflakes = {} // default export object
const flakeStrings = [
  flake1,
  flake2
]
let snowflakeCount = 90
let flakes = new Array(snowflakeCount).fill(null).map(createFlake)
let enableAnimation = true
let windFactor = Math.ceil(Math.random() * 2) - 1
let speed = 1
const windCap = 2

snowflakes.updateCount = (newCount) => {
  newCount = parseInt(newCount)
  if (!newCount || newCount < 0) return
  snowflakeCount = newCount
  flakes.forEach(flake => {
    flake.element.remove()
  })
  flakes = new Array(snowflakeCount).fill(null).map(createFlake)
  snowflakes.start()
}

snowflakes.updateSpeed = (newSpeed) => {
  if (!newSpeed) return
  newSpeed = parseFloat(newSpeed)
  if (newSpeed < 0 || newSpeed > 10) return
  speed = newSpeed
}

function createFlake () {
  const flakeString = flakeStrings[Math.floor(Math.random() * flakeStrings.length)]
  const wrapper = document.createElement('div')
  wrapper.innerHTML = flakeString
  const flakeSvg = wrapper.querySelector('svg')
  const size = Math.random() // 0 to 1
  // between -5 and 105 to allow flakes slightly outside viewport
  const positionX = Math.random() * 116
  const positionY = Math.random() * 116

  document.body.appendChild(wrapper)

  flakeSvg.classList.add('snowflake')
  flakeSvg.style.height = (size * 30 + 10) + 'px'

  return {
    element: flakeSvg,
    x: positionX,
    y: positionY,
    size: size,
    velocity: (size + 0.4) / 3, // let smaller flakes move slower
    rotation: 0,
    // rotate counter clockwise for negative values
    rotationVelocity: (Math.random() * 2) - 1
  }
}

snowflakes.start = () => {
  window.requestAnimationFrame(step)
}

snowflakes.toggle = () => {
  (enableAnimation = !enableAnimation) && snowflakes.start()
}

function step () {
  if (!enableAnimation) return
  if (windFactor > windCap) {
    windFactor -= 0.1
  } else if (windFactor < -windCap) {
    windFactor += 0.1
  } else if (Math.random() > 0.9) {
    // common wind for all flakes. only change every 10th step randomly.
    windFactor += (Math.random() / 10) - 0.05
  }
  flakes.forEach(flake => {
    // apply wind to each flake based on its velocity
    flake.x += windFactor * flake.velocity * speed
    if (flake.x > 107) flake.x = -6 // when clipped right side, move to left side
    if (flake.x < -7) flake.x = 106 // and vice versa

    // fall down
    flake.y += flake.velocity * speed
    if (flake.y > 107) flake.y = 0

    // rotate
    flake.rotation += flake.rotationVelocity
    if (flake.rotation > 360 || flake.rotation < -360) flake.rotation = 0

    // apply styles
    flake.element.style.transform = `translate(${flake.x}vw, ${flake.y}vh) rotate(${flake.rotation}deg)`
  })

  window.requestAnimationFrame(step)
}

export default snowflakes
